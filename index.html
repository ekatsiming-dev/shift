<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- [改善 7] 更新 Title -->
    <title>互動排班月曆 (v2.5 - 響應式改善)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .calendar-day {
            min-height: 110px; /* 增加最小高度以容納標籤 */
        }
        .calendar-day.bg-white:hover {
            background-color: #f8fafc; /* bg-slate-50 */
            transition: background-color 0.2s ease-in-out;
        }
        /* [改善 7] 調整響應式斷點 */
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 90px; /* 調整高度 */
                font-size: 0.875rem;
            }
            .shift-tag {
                font-size: 0.75rem; /* 調整字體 */
                padding: 0.25rem 0.375rem;
            }
            /* [改善 7] 增加 week header 的 mobile padding */
            .weekday-header {
                padding: 0.75rem 0.25rem; /* 減少水平 padding */
            }
        }
        /* Modal 樣式 */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            max-height: 80vh; /* 限制 modal 高度 */
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 p-4 md:p-8">
    
    <!-- [改善 7] 響應式斷點 lg -> md -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-12 gap-8">

        <!-- 控制面板 (v2.4 樣式) -->
        <!-- [改善 7] 響應式斷點 lg:col-span-3 -> md:col-span-4 -->
        <div class="md:col-span-4">
            <div class="bg-white rounded-lg shadow-xl p-6 sticky top-8">
                <h2 class="text-2xl font-extrabold text-slate-900 mb-6 tracking-tight">排班錨點設定</h2>
                
                <form id="schedule-form" class="space-y-6">
                    
                    <fieldset class="space-y-3">
                        <legend class="text-lg font-semibold text-indigo-700 mb-2">1. 班表起訖</legend>
                        <div class="space-y-3">
                            <div>
                                <label for="displayStartDate" class="block text-sm font-medium text-slate-700">起始月份</label>
                                <input type="month" id="displayStartDate" value="2025-12" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm pl-3 pr-9 py-2">
                            </div>
                            <div>
                                <label for="displayEndDate" class="block text-sm font-medium text-slate-700">結束月份</label>
                                <input type="month" id="displayEndDate" value="2026-01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm pl-3 pr-9 py-2">
                            </div>
                        </div>
                    </fieldset>
                    
                    <fieldset class="space-y-3">
                        <legend class="text-lg font-semibold text-indigo-700 mb-2">2. 日曆選項</legend>
                        <div class="space-y-2">
                            <span class="block text-sm font-medium text-slate-700">週首欄</span>
                            <div class="flex items-center gap-x-4">
                                <div class="flex items-center">
                                    <input id="startDaySun" name="startDayOfWeek" type="radio" value="0" checked class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-indigo-600">
                                    <label for="startDaySun" class="ml-2 block text-sm text-slate-900">週日 (預設)</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="startDayMon" name="startDayOfWeek" type="radio" value="1" class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-indigo-600">
                                    <label for="startDayMon" class="ml-2 block text-sm text-slate-900">週一</label>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="space-y-3">
                        <legend class="text-lg font-semibold text-indigo-700 mb-2">3. 週一定錨</legend>
                        <div>
                            <label for="anchorWeekDate" class="block text-sm font-medium text-slate-700">任一<span class="font-semibold text-blue-700">週一</span>的日期</label>
                            <input type="date" id="anchorWeekDate" value="2025-12-01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                        </div>
                        <div>
                            <label for="anchorWeekCode" class="block text-sm font-medium text-slate-700">該<span class="font-semibold text-blue-700">週一</span>的班別代號</label>
                            <select id="anchorWeekCode" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                                <!-- JS 動態填入 -->
                            </select>
                        </div>
                    </fieldset>

                    <fieldset class="space-y-3">
                        <legend class="text-lg font-semibold text-indigo-700 mb-2">4. 週日錨點</legend>
                        <div class="space-y-2">
                            <span class="block text-sm font-medium text-slate-700">選擇錨點班別</span>
                            <div class="flex items-center gap-x-4">
                                <div class="flex items-center">
                                    <input id="anchorSunMain" name="anchorSunType" type="radio" value="主8-12'" checked class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-indigo-600">
                                    <label for="anchorSunMain" class="ml-2 block text-sm text-slate-900">主8-12'</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="anchorSunAlt" name="anchorSunType" type="radio" value="$8-12'" class="h-4 w-4 border-slate-300 text-indigo-600 focus:ring-indigo-600">
                                    <label for="anchorSunAlt" class="ml-2 block text-sm text-slate-900">$8-12'</label>
                                </div>
                            </div>
                        </div>
                         <div>
                            <label for="anchorSunDate" class="block text-sm font-medium text-slate-700">錨點班別的日期 (需為週日)</label>
                            <input type="date" id="anchorSunDate" value="2025-12-14" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                        </div>
                    </fieldset>

                    <!-- [改善 6] 為所有按鈕增加 transition 效果 -->
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 text-base transition-all duration-200">
                        產生班表
                    </button>
                    
                    <button type="button" id="rule-editor-btn" class="w-full bg-slate-600 text-white font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 text-base mt-4 transition-all duration-200">
                        編輯班別規則
                    </button>

                    <div id="error-message" class="text-sm text-red-600 font-medium hidden"></div>
                </form>
            </div>
        </div>

        <!-- 月曆顯示區 -->
        <!-- [改善 7] 響應式斷點 lg:col-span-9 -> md:col-span-8 -->
        <div class="md:col-span-8">
            <div id="calendar-container" class="space-y-8">
                <!-- JS 動態填入 -->
            </div>
        </div>

    </div>

    <!-- 規則編輯器 Modal -->
    <div id="rule-editor-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-4 border-b border-slate-200">
                <h3 class="text-xl font-bold text-slate-900">編輯班別規則</h3>
                <button id="close-rule-editor-btn" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto flex-grow">
                <!-- Tabs -->
                <div class="mb-4 border-b border-slate-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="tab-mon-sat" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-indigo-600 border-indigo-500">
                            週一至六規則 (12週循環)
                        </button>
                        <button id="tab-sun" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 border-transparent hover:text-slate-700 hover:border-slate-300">
                            週日規則 (14週循環)
                        </button>
                    </nav>
                </div>
                
                <!-- Tab Content: Mon-Sat -->
                <div id="tab-content-mon-sat">
                    <div id="mon-sat-editor" class="text-sm">
                        <!-- JS 動態填入 -->
                    </div>
                </div>
                
                <!-- Tab Content: Sun (hidden by default) -->
                <div id="tab-content-sun" class="hidden">
                    <div id="sun-editor" class="text-sm">
                        <!-- JS 動態填入 -->
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="flex justify-end items-center p-4 bg-slate-50 border-t border-slate-200 space-x-3">
                <button id="reset-rules-btn" type="button" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-red-700 transition-all duration-200">
                    重設為預設值
                </button>
                <button id="save-rules-btn" type="button" class="bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-indigo-700 transition-all duration-200">
                    儲存規則
                </button>
            </div>
        </div>
    </div>
    
    <!-- 重設確認 Modal -->
    <div id="reset-confirm-modal" class="fixed inset-0 z-60 flex items-center justify-center p-4 hidden modal-backdrop">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
             <div class="p-6">
                <h4 class="text-lg font-bold text-slate-900">確認重設？</h4>
                <p class="text-sm text-slate-600 mt-2">
                    您確定要將所有班別規則重設為預設值嗎？您儲存的自訂規則將會遺失。
                </p>
             </div>
             <div class="flex justify-end p-4 bg-slate-50 space-x-3">
                <button id="cancel-reset-btn" type="button" class="bg-white text-slate-700 border border-slate-300 font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-slate-50 transition-all duration-200">
                    取消
                </button>
                <button id="confirm-reset-btn" type="button" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-red-700 transition-all duration-200">
                    確定重設
                </button>
             </div>
         </div>
    </div>


    <script>
        // --- 規則資料庫 (v2.3 - 變為可變狀態) ---
        let currentMonSatRules = {};
        let currentSunRules = {};

        // 預設規則
        const DEFAULT_MON_SAT_RULES = {
            'A': { 0: '1-9', 1: '8-1', 2: '8-5', 3: '8-5', 4: '8-5', 5: '8-12' },
            'B': { 0: '8-5', 1: '1-9', 2: '8-1', 3: '8-5', 4: '8-5', 5: 'OFF' },
            'C': { 0: '8-5', 1: '8-5', 2: '8-5', 3: 'OFF', 4: '8-5', 5: '8-5$' },
            'D': { 0: '8-5', 1: '8-5', 2: '1-9', 3: '8-1', 4: '8-5', 5: '8-12' },
            'E': { 0: '8-5', 1: '8-5', 2: '8-5', 3: '1-9', 4: '8-1', 5: 'OFF' },
            'G': { 0: '8-1', 1: '8-5', 2: '8-5', 3: '8-5', 4: '1-9', 5: '8-12' },
            'F': { 0: '1-9', 1: '8-5', 2: '8-5', 3: '8-5', 4: '8-5', 5: 'OFF' },
            'H': { 0: 'OFF', 1: '1-9', 2: '8-5', 3: '8-5', 4: '8-5', 5: '8-12' },
            'I': { 0: '8-5', 1: '8-5', 2: '1-9', 3: '8-5', 4: '8-5', 5: 'OFF' },
            'J': { 0: '8-5', 1: '8-5', 2: '8-5', 3: '8-5', 4: 'OFF', 5: '8-5' },
            'K': { 0: '8-5', 1: '8-5', 2: '8-5', 3: '1-9', 4: '8-5', 5: 'OFF' },
            'L': { 0: '8-5', 1: '8-5', 2: 'OFF', 3: '8-5', 4: '1-9', 5: '8-12' }
        };
        const MON_SAT_CYCLE = ['A', 'B', 'C', 'D', 'E', 'G', 'F', 'H', 'I', 'J', 'K', 'L'];

        const DEFAULT_SUN_RULES = {
            '日1': 'OFF', '日2': "主8-12'", '日3': 'OFF', '日4': 'OFF', '日5': 'OFF',
            '日6': '8-12', '日7': 'OFF', '日8': 'OFF', '日9': '8-12', '日10': 'OFF',
            '日11': 'OFF', '日12': 'OFF', '日13': "$8-12'", '日14': 'OFF'
        };
        const SUN_CYCLE = ['日1', '日2', '日3', '日4', '日5', '日6', '日7', '日8', '日9', '日10', '日11', '日12', '日13', '日14'];
        
        const ALL_SHIFTS = [
            'OFF', '1-9', '8-1', '8-5', '8-5$', '8-12', "主8-12'", "$8-12'"
        ];


        // --- 班別顏色對照表 ---
        const SHIFT_COLORS = {
            'OFF': 'bg-slate-100 text-slate-500 italic',
            '1-9': 'bg-blue-100 text-blue-800',
            '8-1': 'bg-emerald-100 text-emerald-800',
            '8-5': 'bg-amber-100 text-amber-800',
            '8-5$': 'bg-amber-200 text-amber-900 font-semibold',
            '8-12': 'bg-violet-100 text-violet-800',
            "主8-12'": 'bg-red-100 text-red-800 font-bold',
            "$8-12'": 'bg-pink-100 text-pink-800 font-bold',
            'default': 'bg-gray-100 text-gray-900'
        };

        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        const MS_PER_WEEK = MS_PER_DAY * 7;
        
        const WEEKDAY_NAMES_SUN = ['日', '一', '二', '三', '四', '五', '六'];
        const WEEKDAY_NAMES_MON = ['一', '二', '三', '四', '五', '六', '日'];


        // --- DOM 元素 ---
        const form = document.getElementById('schedule-form');
        const calendarContainer = document.getElementById('calendar-container');
        const errorMessage = document.getElementById('error-message');
        const ruleEditorButton = document.getElementById('rule-editor-btn');
        const ruleEditorModal = document.getElementById('rule-editor-modal');
        const closeRuleEditorBtn = document.getElementById('close-rule-editor-btn');
        const saveRulesBtn = document.getElementById('save-rules-btn');
        const resetRulesBtn = document.getElementById('reset-rules-btn');
        const monSatEditorContainer = document.getElementById('mon-sat-editor');
        const sunEditorContainer = document.getElementById('sun-editor');
        const tabMonSat = document.getElementById('tab-mon-sat');
        const tabSun = document.getElementById('tab-sun');
        const tabContentMonSat = document.getElementById('tab-content-mon-sat');
        const tabContentSun = document.getElementById('tab-content-sun');
        const resetConfirmModal = document.getElementById('reset-confirm-modal');
        const confirmResetBtn = document.getElementById('confirm-reset-btn');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');

        
        // --- 核心排班邏輯 (v2.3 更新) ---
        function getMonSatShift(targetDate, params) {
            const dayOfWeek = targetDate.getDay();
            if (dayOfWeek === 0) return { shift: 'N/A', rule: 'N/A' };
            const dayDiffFromMon = (dayOfWeek === 0) ? 6 : (dayOfWeek - 1);
            const targetMonday = new Date(targetDate.getTime() - dayDiffFromMon * MS_PER_DAY);
            targetMonday.setHours(0, 0, 0, 0);
            const anchorMonday = new Date(params.anchorWeekDate);
            anchorMonday.setHours(0, 0, 0, 0);
            const weeksDiff = Math.round((targetMonday.getTime() - anchorMonday.getTime()) / MS_PER_WEEK);
            const anchorIndex = MON_SAT_CYCLE.indexOf(params.anchorWeekCode);
            if (anchorIndex === -1) return { shift: '錯誤', rule: '錯誤' };
            const cycleIndex = (anchorIndex + weeksDiff % 12 + 12) % 12;
            const currentRuleCode = MON_SAT_CYCLE[cycleIndex];
            const ruleDayIndex = dayOfWeek - 1; 
            const shift = currentMonSatRules[currentRuleCode][ruleDayIndex];
            return { shift: shift, rule: currentRuleCode };
        }

        function getSundayShift(targetDate, params) {
            if (targetDate.getDay() !== 0) return { shift: 'N/A', rule: 'N/A' };
            let sunAnchorDate = new Date(params.anchorSunDate);
            let sunAnchorRuleName = params.anchorSunType; 
            sunAnchorDate.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);
            const anchorRuleCode = Object.keys(currentSunRules).find(key => currentSunRules[key] === sunAnchorRuleName);
            if (!anchorRuleCode) return { shift: '錨點錯誤', rule: '錯誤' };
            const anchorIndex = SUN_CYCLE.indexOf(anchorRuleCode);
            if (anchorIndex === -1) return { shift: '循環錯誤', rule: '錯誤' };
            const weeksDiff = Math.round((targetDate.getTime() - sunAnchorDate.getTime()) / MS_PER_WEEK);
            const cycleIndex = (anchorIndex + weeksDiff % 14 + 14) % 14;
            const currentRuleCode = SUN_CYCLE[cycleIndex];
            const shift = currentSunRules[currentRuleCode];
            return { shift: shift, rule: currentRuleCode };
        }

        /**
         * 繪製指定月份的月曆 (v2.4 視覺調整)
         */
        function renderMonth(year, month, params) {
            const monthName = new Date(year, month).toLocaleString('zh-TW', { month: 'long', year: 'numeric' });
            const startDay = parseInt(params.startDay, 10) || 0; 
            const WEEKDAY_NAMES = (startDay === 1) ? WEEKDAY_NAMES_MON : WEEKDAY_NAMES_SUN;

            let monthHtml = `
                <!-- [改善 2] 陰影加深 -->
                <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                    <!-- [改善 4] 月份標題加大、padding 增加 -->
                    <h2 class="text-2xl font-bold text-slate-900 p-5 bg-slate-50 border-b border-slate-200">${monthName}</h2>
                    <div class="grid grid-cols-7 border-b border-slate-200">
            `;
            
            WEEKDAY_NAMES.forEach((day, index) => {
                const isSunHeader = (startDay === 0 && index === 0) || (startDay === 1 && index === 6);
                // [改善 7] 增加 'weekday-header' class 以便 CSS 控制
                monthHtml += `<div class="weekday-header p-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider ${isSunHeader ? 'text-red-500' : ''}">${day}</div>`;
            });
            monthHtml += `</div><div class="grid grid-cols-7">`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            let firstDayOfWeek = firstDay.getDay(); 
            if (startDay === 1) {
                firstDayOfWeek = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1;
            }
            
            for (let i = 0; i < firstDayOfWeek; i++) {
                monthHtml += `<div class="calendar-day bg-slate-50 border-r border-b border-slate-200"></div>`;
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();
                
                let result;
                if (dayOfWeek === 0) {
                    result = getSundayShift(currentDate, params);
                } else {
                    result = getMonSatShift(currentDate, params);
                }

                const isSun = dayOfWeek === 0;
                const colorClass = SHIFT_COLORS[result.shift] || SHIFT_COLORS['default'];
                
                let dayClass = 'calendar-day relative p-2 border-r border-b border-slate-200 flex flex-col';
                let dateClass = 'font-semibold';
                let shiftClass = `shift-tag mt-1 rounded-md px-2 py-1 text-sm md:text-base flex-grow flex items-center justify-center ${colorClass}`;

                if (isSun) {
                    dayClass += ' bg-red-50';
                    dateClass += ' text-red-600';
                } else {
                    dayClass += ' bg-white'; // [改善 5] 確保 hover 效果能觸發
                    dateClass += ' text-slate-800';
                }

                const isLastCol = (startDay === 1) ? (dayOfWeek === 0) : (dayOfWeek === 6);
                if (isLastCol) {
                    dayClass = dayClass.replace('border-r', '');
                }

                monthHtml += `
                    <div class="${dayClass}">
                        <div class="${dateClass}">${day}</div>
                        <div class="${shiftClass}">${result.shift}</div>
                    </div>
                `;
            }

            let lastDayOfWeek = lastDay.getDay();
            if (startDay === 1) {
                lastDayOfWeek = (lastDayOfWeek === 0) ? 6 : lastDayOfWeek - 1;
            }

            if (lastDayOfWeek !== 6) {
                for (let i = lastDayOfWeek + 1; i <= 6; i++) {
                    let padClass = "calendar-day bg-slate-50 border-r border-b border-slate-200";
                    if (i === 6) padClass = padClass.replace('border-r', '');
                    monthHtml += `<div class="${padClass}"></div>`;
                }
            }

            monthHtml += `</div></div>`;
            calendarContainer.innerHTML += monthHtml;
        }

        /**
         * 驗證輸入參數
         */
        function validateParams(params) {
            if (params.anchorWeekDate && new Date(params.anchorWeekDate).getDay() !== 1) {
                return "週一定錨錯誤： 您選擇的日期必須是週一。";
            }
            if (!params.anchorWeekDate || !params.anchorWeekCode) {
                return "週一定錨錯誤： 請同時提供日期和班別代號。";
            }
            if (params.anchorSunDate && new Date(params.anchorSunDate).getDay() !== 0) {
                return "週日錨點錯誤： 您選擇的日期必須是週日。";
            }
            if (!params.anchorSunDate || !params.anchorSunType) {
                 return "週日錨點錯誤： 請選擇錨點班別並提供對應的週日日期。";
            }
            if (params.displayStartDate > params.displayEndDate) {
                return "日期範圍錯誤： 起始月份不能晚於結束月份。";
            }
            return null; // All valid
        }

        /**
         * 處理表dan提交，產生班表
         */
        function generateScheduleFromForm(e) {
            if (e) e.preventDefault();
            
            const formValues = {
                displayStartDate: document.getElementById('displayStartDate').value,
                displayEndDate: document.getElementById('displayEndDate').value,
                anchorWeekDate: document.getElementById('anchorWeekDate').value,
                anchorWeekCode: document.getElementById('anchorWeekCode').value,
                anchorSunType: document.querySelector('input[name="anchorSunType"]:checked').value,
                anchorSunDate: document.getElementById('anchorSunDate').value,
                startDay: document.querySelector('input[name="startDayOfWeek"]:checked').value
            };
            
            const params = {
                ...formValues,
                displayStartDate: new Date(formValues.displayStartDate + '-01T00:00:00'),
                displayEndDate: new Date(formValues.displayEndDate + '-01T00:00:00'),
            };

            params.displayEndDate.setMonth(params.displayEndDate.getMonth() + 1);
            params.displayEndDate.setDate(0);

            const error = validateParams(params);
            if (error) {
                errorMessage.textContent = error;
                errorMessage.classList.remove('hidden');
                calendarContainer.innerHTML = '';
                return;
            }

            try {
                localStorage.setItem('scheduleSettings', JSON.stringify(formValues));
            } catch (e) {
                console.error("Failed to save settings:", e);
            }

            errorMessage.classList.add('hidden');
            calendarContainer.innerHTML = '';

            let currentDate = new Date(params.displayStartDate);
            while (currentDate <= params.displayEndDate) {
                renderMonth(currentDate.getFullYear(), currentDate.getMonth(), params);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
        }

        /**
         * 填充週班代號下拉選單
         */
        function populateSelects() {
            const select = document.getElementById('anchorWeekCode');
            select.innerHTML = ''; 
            MON_SAT_CYCLE.forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code;
                select.appendChild(option);
            });
        }
        
        /**
         * 載入設定
         */
        function loadSettings() {
            const savedSettings = localStorage.getItem('scheduleSettings');
            if (!savedSettings) return;

            try {
                const settings = JSON.parse(savedSettings);
                
                document.getElementById('displayStartDate').value = settings.displayStartDate || '2025-12';
                document.getElementById('displayEndDate').value = settings.displayEndDate || '2026-01';
                document.getElementById('anchorWeekDate').value = settings.anchorWeekDate || '2025-12-01';
                document.getElementById('anchorWeekCode').value = settings.anchorWeekCode || 'C';
                document.getElementById('anchorSunDate').value = settings.anchorSunDate || '2025-12-14';

                document.querySelector(`input[name="startDayOfWeek"][value="${settings.startDay || '0'}"]`).checked = true;
                document.querySelector(`input[name="anchorSunType"][value="${settings.anchorSunType || "主8-12'"}"]`).checked = true;

            } catch (e) {
                console.error("Failed to load settings:", e);
                localStorage.removeItem('scheduleSettings'); 
            }
        }
        
        // --- 規則編輯器相關函式 ---
        
        function saveRules() {
            try {
                localStorage.setItem('customMonSatRules', JSON.stringify(currentMonSatRules));
                localStorage.setItem('customSunRules', JSON.stringify(currentSunRules));
                console.log("Rules saved to localStorage.");
                generateScheduleFromForm(null); 
            } catch (e) {
                console.error("Failed to save rules:", e);
            }
        }

        function loadRules() {
            const savedMonSat = localStorage.getItem('customMonSatRules');
            const savedSun = localStorage.getItem('customSunRules');

            try {
                currentMonSatRules = savedMonSat ? JSON.parse(savedMonSat) : JSON.parse(JSON.stringify(DEFAULT_MON_SAT_RULES));
            } catch (e) {
                console.error("Failed to load Mon-Sat rules, using defaults.", e);
                currentMonSatRules = JSON.parse(JSON.stringify(DEFAULT_MON_SAT_RULES));
            }

            try {
                currentSunRules = savedSun ? JSON.parse(savedSun) : JSON.parse(JSON.stringify(DEFAULT_SUN_RULES));
            } catch (e) {
                console.error("Failed to load Sun rules, using defaults.", e);
                currentSunRules = JSON.parse(JSON.stringify(DEFAULT_SUN_RULES));
            }
             console.log("Rules loaded.");
        }

        function createShiftSelect(id, selectedValue) {
            let optionsHtml = ALL_SHIFTS.map(shift => 
                `<option value="${shift}" ${shift === selectedValue ? 'selected' : ''}>${shift}</option>`
            ).join('');
            return `<select id="${id}" class="w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-1">
                        ${optionsHtml}
                    </select>`;
        }

        function populateRuleEditor() {
            // 填充週一至六
            let monSatHtml = `
                <div class="grid grid-cols-[auto_repeat(6,1fr)] gap-x-2 items-center font-semibold mb-2 text-sm text-center sticky top-0 bg-white py-2">
                    <div>代號</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                </div>`;
            MON_SAT_CYCLE.forEach(ruleCode => {
                const rule = currentMonSatRules[ruleCode];
                monSatHtml += `<div class="grid grid-cols-[auto_repeat(6,1fr)] gap-x-2 gap-y-2 items-center mb-2">`;
                monSatHtml += `<div class="font-bold text-center text-indigo-700">${ruleCode}</div>`; // Rule Code
                for (let i = 0; i < 6; i++) {
                    const shift = rule[i];
                    monSatHtml += `<div>${createShiftSelect(`ms-${ruleCode}-${i}`, shift)}</div>`;
                }
                monSatHtml += `</div>`;
            });
            monSatEditorContainer.innerHTML = monSatHtml;
            
            // 填充週日
            let sunHtml = `<div class="grid grid-cols-3 gap-x-4 gap-y-3 items-center max-w-sm mx-auto">`;
            SUN_CYCLE.forEach(ruleCode => {
                const shift = currentSunRules[ruleCode];
                sunHtml += `<div class="font-bold text-sm text-indigo-700">${ruleCode}</div>`;
                sunHtml += `<div class="col-span-2">${createShiftSelect(`sun-${ruleCode}`, shift)}</div>`;
            });
            sunHtml += `</div>`;
            sunEditorContainer.innerHTML = sunHtml;
        }

        function saveRulesFromEditor() {
            try {
                // 讀取週一至六
                MON_SAT_CYCLE.forEach(ruleCode => {
                    for (let i = 0; i < 6; i++) {
                        const selectId = `ms-${ruleCode}-${i}`;
                        const select = document.getElementById(selectId);
                        if(select) {
                            currentMonSatRules[ruleCode][i] = select.value;
                        }
                    }
                });

                // 讀取週日
                SUN_CYCLE.forEach(ruleCode => {
                    const selectId = `sun-${ruleCode}`;
                    const select = document.getElementById(selectId);
                    if(select) {
                        currentSunRules[ruleCode] = select.value;
                    }
                });

                saveRules();
                ruleEditorModal.classList.add('hidden');
            } catch (e) {
                console.error("Error saving rules:", e);
            }
        }
        
        function setupTabs() {
            tabMonSat.addEventListener('click', () => {
                tabContentMonSat.classList.remove('hidden');
                tabContentSun.classList.add('hidden');
                tabMonSat.classList.add('text-indigo-600', 'border-indigo-500');
                tabMonSat.classList.remove('text-slate-500', 'border-transparent', 'hover:text-slate-700', 'hover:border-slate-300');
                tabSun.classList.add('text-slate-500', 'border-transparent', 'hover:text-slate-700', 'hover:border-slate-300');
                tabSun.classList.remove('text-indigo-600', 'border-indigo-500');
            });
            tabSun.addEventListener('click', () => {
                tabContentSun.classList.remove('hidden');
                tabContentMonSat.classList.add('hidden');
                tabSun.classList.add('text-indigo-600', 'border-indigo-500');
                tabSun.classList.remove('text-slate-500', 'border-transparent', 'hover:text-slate-700', 'hover:border-slate-300');
                tabMonSat.classList.add('text-slate-500', 'border-transparent', 'hover:text-slate-700', 'hover:border-slate-300');
                tabMonSat.classList.remove('text-indigo-600', 'border-indigo-500');
            });
        }

        // --- 頁面載入時初始化 ---
        window.onload = () => {
            populateSelects(); 
            loadRules(); 
            loadSettings(); 
            setupTabs();
            
            form.addEventListener('submit', generateScheduleFromForm);
            
            ruleEditorButton.addEventListener('click', () => {
                 populateRuleEditor(); 
                 ruleEditorModal.classList.remove('hidden'); 
            });
            closeRuleEditorBtn.addEventListener('click', () => { ruleEditorModal.classList.add('hidden'); });
            saveRulesBtn.addEventListener('click', saveRulesFromEditor);
            
            resetRulesBtn.addEventListener('click', () => {
                resetConfirmModal.classList.remove('hidden');
            });
            cancelResetBtn.addEventListener('click', () => {
                resetConfirmModal.classList.add('hidden');
            });
            confirmResetBtn.addEventListener('click', () => {
                localStorage.removeItem('customMonSatRules');
                localStorage.removeItem('customSunRules');
                loadRules(); 
                populateRuleEditor(); 
                generateScheduleFromForm(null); 
                resetConfirmModal.classList.add('hidden');
            });
            
            generateScheduleFromForm(null); 
        };

    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動排班月曆 (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .calendar-day {
            min-height: 110px; /* 增加最小高度以容納標籤 */
        }
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 80px;
                font-size: 0.875rem;
            }
            .shift-tag {
                font-size: 0.8rem;
                padding: 0.25rem 0.375rem;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 p-4 md:p-8">
    
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- 控制面板 (v2 樣式) -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-lg shadow-lg p-6 sticky top-8">
                <h2 class="text-2xl font-bold text-slate-900 mb-6">排班錨點設定</h2>
                
                <form id="schedule-form" class="space-y-6">
                    
                    <fieldset class="space-y-3">
                        <legend class="text-lg font-semibold text-indigo-700 mb-2">1. 顯示範圍</legend>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="displayStartDate" class="block text-sm font-medium text-slate-700">起始月份</label>
                                <input type="month" id="displayStartDate" value="2025-12" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                            </div>
                            <div>
                                <label for="displayEndDate" class="block text-sm font-medium text-slate-700">結束月份</label>
                                <input type="month" id="displayEndDate" value="2026-01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="space-y-3">
                        <legend class="text-lg font-semibold text-indigo-700 mb-2">2. 週一至週六錨點</legend>
                        <div>
                            <label for="anchorWeekDate" class="block text-sm font-medium text-slate-700">任一週一的日期</label>
                            <input type="date" id="anchorWeekDate" value="2025-12-01" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                        </div>
                        <div>
                            <label for="anchorWeekCode" class="block text-sm font-medium text-slate-700">該週一的班別代號</label>
                            <select id="anchorWeekCode" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                                <!-- JS 動態填入 -->
                            </select>
                        </div>
                    </fieldset>

                    <fieldset class="space-y-3">
                        <legend class="text-lg font-semibold text-indigo-700 mb-2">3. 週日錨點</legend>
                        <div>
                            <label for="anchorSunType" class="block text-sm font-medium text-slate-700">選擇錨點班別</label>
                            <select id="anchorSunType" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                                <option value="主8-12'" selected>主8-12'</option>
                                <option value="$8-12'">$8-12'</option>
                            </select>
                        </div>
                         <div>
                            <label for="anchorSunDate" class="block text-sm font-medium text-slate-700">錨點班別的日期 (需為週日)</label>
                            <input type="date" id="anchorSunDate" value="2025-12-14" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base p-2">
                        </div>
                    </fieldset>

                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 text-base">
                        產生班表
                    </button>

                    <div id="error-message" class="text-sm text-red-600 font-medium hidden"></div>
                </form>
            </div>
        </div>

        <!-- 月曆顯示區 -->
        <div class="lg:col-span-9">
            <div id="calendar-container" class="space-y-8">
                <!-- JS 動態填入 -->
            </div>
        </div>

    </div>

    <script>
        // --- 規則資料庫 (來自CSV檔案) ---
        const MON_SAT_RULES = {
            'A': { 0: '1-9', 1: '8-1', 2: '8-5', 3: '8-5', 4: '8-5', 5: '8-12' },
            'B': { 0: '8-5', 1: '1-9', 2: '8-1', 3: '8-5', 4: '8-5', 5: 'OFF' },
            'C': { 0: '8-5', 1: '8-5', 2: '8-5', 3: 'OFF', 4: '8-5', 5: '8-5$' },
            'D': { 0: '8-5', 1: '8-5', 2: '1-9', 3: '8-1', 4: '8-5', 5: '8-12' },
            'E': { 0: '8-5', 1: '8-5', 2: '8-5', 3: '1-9', 4: '8-1', 5: 'OFF' },
            'G': { 0: '8-1', 1: '8-5', 2: '8-5', 3: '8-5', 4: '1-9', 5: '8-12' },
            'F': { 0: '1-9', 1: '8-5', 2: '8-5', 3: '8-5', 4: '8-5', 5: 'OFF' },
            'H': { 0: 'OFF', 1: '1-9', 2: '8-5', 3: '8-5', 4: '8-5', 5: '8-12' },
            'I': { 0: '8-5', 1: '8-5', 2: '1-9', 3: '8-5', 4: '8-5', 5: 'OFF' },
            'J': { 0: '8-5', 1: '8-5', 2: '8-5', 3: '8-5', 4: 'OFF', 5: '8-5' },
            'K': { 0: '8-5', 1: '8-5', 2: '8-5', 3: '1-9', 4: '8-5', 5: 'OFF' },
            'L': { 0: '8-5', 1: '8-5', 2: 'OFF', 3: '8-5', 4: '1-9', 5: '8-12' } // 規則已根據您的圖片修正 (週三 OFF, 週六 8-12)
        };
        const MON_SAT_CYCLE = ['A', 'B', 'C', 'D', 'E', 'G', 'F', 'H', 'I', 'J', 'K', 'L'];

        const SUN_RULES = {
            '日1': 'OFF', '日2': "主8-12'", '日3': 'OFF', '日4': 'OFF', '日5': 'OFF',
            '日6': '8-12', '日7': 'OFF', '日8': 'OFF', '日9': '8-12', '日10': 'OFF',
            '日11': 'OFF', '日12': 'OFF', '日13': "$8-12'", '日14': 'OFF'
        };
        const SUN_CYCLE = ['日1', '日2', '日3', '日4', '日5', '日6', '日7', '日8', '日9', '日10', '日11', '日12', '日13', '日14'];

        // --- 班別顏色對照表 ---
        const SHIFT_COLORS = {
            'OFF': 'bg-slate-100 text-slate-500 italic',
            '1-9': 'bg-blue-100 text-blue-800',
            '8-1': 'bg-emerald-100 text-emerald-800',
            '8-5': 'bg-amber-100 text-amber-800',
            '8-5$': 'bg-amber-200 text-amber-900 font-semibold', // 8-5 變體
            '8-12': 'bg-violet-100 text-violet-800',
            "主8-12'": 'bg-red-100 text-red-800 font-bold',
            "$8-12'": 'bg-pink-100 text-pink-800 font-bold',
            'default': 'bg-gray-100 text-gray-900' // 預防錯誤
        };

        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        const MS_PER_WEEK = MS_PER_DAY * 7;
        const WEEKDAY_NAMES = ['日', '一', '二', '三', '四', '五', '六'];

        // --- DOM 元素 ---
        const form = document.getElementById('schedule-form');
        const calendarContainer = document.getElementById('calendar-container');
        const errorMessage = document.getElementById('error-message');
        
        // --- 核心排班邏輯 (週一至六不變) ---
        function getMonSatShift(targetDate, params) {
            // ... (此函數與 v1 完全相同) ...
            const dayOfWeek = targetDate.getDay();
            if (dayOfWeek === 0) return { shift: 'N/A', rule: 'N/A' };
            const dayDiffFromMon = (dayOfWeek === 0) ? 6 : (dayOfWeek - 1);
            const targetMonday = new Date(targetDate.getTime() - dayDiffFromMon * MS_PER_DAY);
            targetMonday.setHours(0, 0, 0, 0);
            const anchorMonday = new Date(params.anchorWeekDate);
            anchorMonday.setHours(0, 0, 0, 0);
            const weeksDiff = Math.round((targetMonday.getTime() - anchorMonday.getTime()) / MS_PER_WEEK);
            const anchorIndex = MON_SAT_CYCLE.indexOf(params.anchorWeekCode);
            if (anchorIndex === -1) return { shift: '錯誤', rule: '錯誤' };
            const cycleIndex = (anchorIndex + weeksDiff % 12 + 12) % 12;
            const currentRuleCode = MON_SAT_CYCLE[cycleIndex];
            const ruleDayIndex = dayOfWeek - 1; 
            const shift = MON_SAT_RULES[currentRuleCode][ruleDayIndex];
            return { shift: shift, rule: currentRuleCode };
        }

        /**
         * 取得指定日期的週日班別 (v2 更新)
         * @param {Date} targetDate - 目標日期 (必須是週日)
         * @param {object} params - 錨點參數
         * @returns {{shift: string, rule: string}}
         */
        function getSundayShift(targetDate, params) {
            if (targetDate.getDay() !== 0) return { shift: 'N/A', rule: 'N/A' };

            // v2: 根據新的表單欄位讀取錨點
            let sunAnchorDate = new Date(params.anchorSunDate);
            let sunAnchorRuleName = params.anchorSunType; // "主8-12'" 或 "$8-12'"
            
            sunAnchorDate.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);

            const anchorRuleCode = Object.keys(SUN_RULES).find(key => SUN_RULES[key] === sunAnchorRuleName);
            if (!anchorRuleCode) return { shift: '錨點錯誤', rule: '錯誤' };
            
            const anchorIndex = SUN_CYCLE.indexOf(anchorRuleCode);
            if (anchorIndex === -1) return { shift: '循環錯誤', rule: '錯誤' };

            const weeksDiff = Math.round((targetDate.getTime() - sunAnchorDate.getTime()) / MS_PER_WEEK);
            const cycleIndex = (anchorIndex + weeksDiff % 14 + 14) % 14;
            const currentRuleCode = SUN_CYCLE[cycleIndex];
            const shift = SUN_RULES[currentRuleCode];

            return { shift: shift, rule: currentRuleCode };
        }

        /**
         * 繪製指定月份的月曆 (v2 更新)
         * @param {number} year - 年份
         * @param {number} month - 月份 (0-11)
         * @param {object} params - 錨點參數
         */
        function renderMonth(year, month, params) {
            const monthName = new Date(year, month).toLocaleString('zh-TW', { month: 'long', year: 'numeric' });
            
            let monthHtml = `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <h2 class="text-xl font-bold text-slate-900 p-4 bg-slate-50 border-b border-slate-200">${monthName}</h2>
                    <div class="grid grid-cols-7 border-b border-slate-200">
            `;
            
            WEEKDAY_NAMES.forEach((day, index) => {
                monthHtml += `<div class="p-2 text-center text-sm font-semibold text-slate-600 ${index === 0 ? 'text-red-500' : ''}">${day}</div>`;
            });
            monthHtml += `</div><div class="grid grid-cols-7">`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            
            for (let i = 0; i < firstDayOfWeek; i++) {
                monthHtml += `<div class="calendar-day bg-slate-50 border-r border-b border-slate-200"></div>`;
            }

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();
                
                let result;
                if (dayOfWeek === 0) {
                    result = getSundayShift(currentDate, params);
                } else {
                    result = getMonSatShift(currentDate, params);
                }

                // v2: 班別顏色邏輯
                const isSun = dayOfWeek === 0;
                const colorClass = SHIFT_COLORS[result.shift] || SHIFT_COLORS['default'];
                
                let dayClass = 'calendar-day relative p-2 border-r border-b border-slate-200 flex flex-col';
                let dateClass = 'font-semibold';
                // v2: shift-tag 樣式
                let shiftClass = `shift-tag mt-1 rounded-md px-2 py-1 text-sm md:text-base flex-grow flex items-center justify-center ${colorClass}`;

                if (isSun) {
                    dayClass += ' bg-red-50';
                    dateClass += ' text-red-600';
                } else {
                    dayClass += ' bg-white';
                    dateClass += ' text-slate-800';
                }

                if (dayOfWeek === 6) {
                    dayClass = dayClass.replace('border-r', '');
                }

                monthHtml += `
                    <div class="${dayClass}">
                        <div class="${dateClass}">${day}</div>
                        <div class="${shiftClass}">${result.shift}</div>
                    </div>
                `;
            }

            const lastDayOfWeek = lastDay.getDay();
            if (lastDayOfWeek !== 6) {
                for (let i = lastDayOfWeek + 1; i <= 6; i++) {
                    let padClass = "calendar-day bg-slate-50 border-r border-b border-slate-200";
                    if (i === 6) padClass = padClass.replace('border-r', '');
                    monthHtml += `<div class="${padClass}"></div>`;
                }
            }

            monthHtml += `</div></div>`;
            calendarContainer.innerHTML += monthHtml;
        }

        /**
         * 驗證輸入參數 (v2 更新)
         * @param {object} params
         * @returns {string|null} - Error message or null if valid
         */
        function validateParams(params) {
            if (params.anchorWeekDate && new Date(params.anchorWeekDate).getDay() !== 1) {
                return "週一至週六錨點錯誤： 您選擇的日期必須是週一。";
            }
            if (!params.anchorWeekDate || !params.anchorWeekCode) {
                return "週一至週六錨點錯誤： 請同時提供日期和班別代號。";
            }
            if (params.anchorSunDate && new Date(params.anchorSunDate).getDay() !== 0) {
                return "週日錨點錯誤： 您選擇的日期必須是週日。";
            }
            if (!params.anchorSunDate || !params.anchorSunType) {
                 return "週日錨點錯誤： 請選擇錨點班別並提供對應的週日日期。";
            }
            if (params.displayStartDate > params.displayEndDate) {
                return "日期範圍錯誤： 起始月份不能晚於結束月份。";
            }
            return null; // All valid
        }

        /**
         * 處理表單提交，產生班表 (v2 更新)
         */
        function generateScheduleFromForm(e) {
            if (e) e.preventDefault();
            
            // v2: 讀取新的表單欄位
            const params = {
                displayStartDate: new Date(document.getElementById('displayStartDate').value + '-01T00:00:00'),
                displayEndDate: new Date(document.getElementById('displayEndDate').value + '-01T00:00:00'),
                anchorWeekDate: document.getElementById('anchorWeekDate').value,
                anchorWeekCode: document.getElementById('anchorWeekCode').value,
                anchorSunType: document.getElementById('anchorSunType').value,
                anchorSunDate: document.getElementById('anchorSunDate').value
            };

            params.displayEndDate.setMonth(params.displayEndDate.getMonth() + 1);
            params.displayEndDate.setDate(0);

            const error = validateParams(params);
            if (error) {
                errorMessage.textContent = error;
                errorMessage.classList.remove('hidden');
                calendarContainer.innerHTML = '';
                return;
            }

            errorMessage.classList.add('hidden');
            calendarContainer.innerHTML = '';

            let currentDate = new Date(params.displayStartDate);
            while (currentDate <= params.displayEndDate) {
                renderMonth(currentDate.getFullYear(), currentDate.getMonth(), params);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
        }

        /**
         * 填充週班代號下拉選單
         */
        function populateSelects() {
            const select = document.getElementById('anchorWeekCode');
            MON_SAT_CYCLE.forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code;
                if (code === 'C') { // 預設選中 C
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // --- 頁面載入時初始化 ---
        window.onload = () => {
            populateSelects();
            form.addEventListener('submit', generateScheduleFromForm);
            generateScheduleFromForm(null); 
        };

    </script>
</body>
</html>


